@model Job.ViewModel.CApplyManagementViewModel

@functions {
    // 業主回覆 Icon
    private string OwnerReplyIconHtml(string reply)
    {
        return reply switch
        {
            "待處理" => "<i class=\"bi bi-hourglass-split text-warning\"></i> 待處理",
            "已接受" => "<i class=\"bi bi-check-circle text-success\"></i> 已接受",
            "未接受" => "<i class=\"bi bi-x-circle text-danger\"></i> 未接受",
            _ => $"<i class=\"bi bi-question-circle text-secondary\"></i> {reply}"
        };
    }

    // 換宿者回覆 Icon
    private string WorkerReplyIconHtml(string reply)
    {
        return reply switch
        {
            "待處理" => "<i class=\"bi bi-hourglass-split text-warning\"></i> 待處理",
            "已錄取" => "<i class=\"bi bi-check-circle text-success\"></i> 已錄取",
            "未錄取" => "<i class=\"bi bi-x-circle text-danger\"></i> 未錄取",
            _ => $"<i class=\"bi bi-question-circle text-secondary\"></i> {reply}"
        };
    }
}

<div class="container mt-4">
    <h1>換宿者申請列表 <i class="fa-solid fa-list-ul"></i></h1>

    <form asp-action="ApplyList" method="get">
        <div id="QueryPanel" class="card mb-3">
            <div class="card-header">資料查詢</div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">關鍵字(換宿者姓名或應徵業主)</label>
                        <input type="text" asp-for="txtKeyword" class="form-control" />
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">業主回覆</label>
                        <select asp-for="WorkerReply" asp-items="ViewBag.WorkerReplyList" class="form-select">
                            <option value="">全部</option>
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">換宿者回覆</label>

                        <select asp-for="ApplyStatus" asp-items="ViewBag.StatusList" class="form-select">
                            <option value="">全部</option>
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">申請日期起</label>
                        <input type="date" asp-for="StartDate" class="form-control" />
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">申請日期迄</label>
                        <input type="date" asp-for="EndDate" class="form-control" />
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <button type="submit" class="btn btn-primary"><i class="bi bi-search"></i>查詢</button>
                <a asp-action="ApplyList" asp-controller="Apply" asp-area="Back" class="btn btn-secondary">
                    <i class="bi bi-x-circle"></i> 清除查詢
                </a>
            </div>
        </div>
    </form>

    <div class="card">
        <div class="card-body">
            <table class="table table-bordered table-hover text-center">
                <thead class="table-info">
                    <tr>
                        <th>序號</th>
                        <th>換宿者姓名</th>
                        <th>應徵公司</th>
                        <th>申請日期</th>
                        <th>業主回覆</th>
                        <th>換宿者回覆</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        int count = 0;
                    }
                    @foreach (var item in Model.TworkerApplies)
                    {
                        count++;

                        // 找對應的業主回覆
                        var admissions = Model.TownerAdmissions?
                        .Where(a => a.MemberId == item.MemberId)
                        .Select(a => a.ReplySituation)
                        ?? Enumerable.Empty<string>();

                        string ownerStatus = admissions.Any()
                        ? string.Join(", ", admissions)
                        : "待處理";

                        // 換宿者回覆
                        string workerStatus = string.IsNullOrEmpty(item.ApplySituation) ? "待處理" : item.ApplySituation;

                        <tr>
                            <td>@count</td>
                            <td>@item.WorkerName</td>
                            <td>@item.ApplyOwner</td>
                            <td>@item.ApplyDate.ToString("yyyy/MM/dd")</td>
                            <td>@Html.Raw(WorkerReplyIconHtml(workerStatus))</td>
                            <td>@Html.Raw(OwnerReplyIconHtml(ownerStatus))</td>
                            <td>
                                <a asp-action="applyDetail" asp-controller="Apply" asp-route-id="@item.WorkerApplyId"
                                   class="btn btn-warning btn-sm">
                                    <i class="bi bi-info-circle"></i> 詳細資訊
                                </a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="~/lib/jquery/dist/jquery.min.js"></script>
<script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
<script src="~/js/site.js" asp-append-version="true"></script>
